<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hand Tracking Particles - Fix</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; z-index: 10; pointer-events: none; }
        #video_container { position: absolute; bottom: 10px; right: 10px; width: 180px; height: 120px; border: 1px solid #333; transform: scaleX(-1); border-radius: 10px; }
        canvas { display: block; }
    </style>
</head>
<body>

<div id="ui">
    <h2>Particle Controller</h2>
    <div id="status">Waiting for Camera...</div>
</div>
<video id="input_video" style="display:none" playsinline></video>
<canvas id="video_container"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
    const statusText = document.getElementById('status');
    const PARTICLE_COUNT = 3000;
    
    // --- Scene Setup ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    camera.position.z = 15;

    // --- Particles ---
    const geometry = new THREE.BufferGeometry();
    const posArray = new Float32Array(PARTICLE_COUNT * 3);
    for(let i=0; i<PARTICLE_COUNT*3; i++) posArray[i] = (Math.random() - 0.5) * 20;
    geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    
    const material = new THREE.PointsMaterial({ size: 0.08, color: 0x00ffff, transparent: true, blending: THREE.AdditiveBlending });
    const points = new THREE.Points(geometry, material);
    scene.add(points);

    // --- Hand Tracking ---
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });

    let targetX = 0, targetY = 0;

    hands.onResults((results) => {
        statusText.innerText = "Tracking Active!";
        if (results.multiHandLandmarks && results.multiHandLandmarks[0]) {
            const p = results.multiHandLandmarks[0][9];
            targetX = (p.x - 0.5) * -30;
            targetY = (p.y - 0.5) * -20;
        }
    });

    const videoElement = document.getElementById('input_video');
    const cam = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 640, height: 480
    });
    
    // Attempt to start
    cam.start().catch(err => {
        statusText.innerText = "Error: Camera access denied or blocked by browser.";
        console.error(err);
    });

    // --- Animation ---
    function animate() {
        requestAnimationFrame(animate);
        
        const positions = geometry.attributes.position.array;
        for(let i = 0; i < PARTICLE_COUNT; i++) {
            const i3 = i * 3;
            // Particles gravitate toward hand
            positions[i3] += (targetX - positions[i3]) * 0.01 + (Math.random()-0.5)*0.1;
            positions[i3+1] += (targetY - positions[i3+1]) * 0.01 + (Math.random()-0.5)*0.1;
        }
        geometry.attributes.position.needsUpdate = true;
        
        renderer.render(scene, camera);
    }
    animate();
</script>
</body>
</html>
